#!/usr/bin/env zsh

DEFAULT_PARAMS_FILE=.default_params

if (($#<2)); then
    print -- "usage: $0:t request [-p params] object"
    print -- "where request is GET, PUT, POST or DELETE"
    print -- "You can create a $DEFAULT_PARAMS_FILE file to put your default params."
    print -- "It will use the first file found by getting up in the file system up to /"
    exit 1
fi

DEFAULT_PARAMS_FILE=.default_params

while [[ $(pwd) != '/' ]]; do
    if [[ -f $DEFAULT_PARAMS_FILE ]]; then
        params='-d '$(< $DEFAULT_PARAMS_FILE)
        break
    fi
    cd ..
done


request=$1
shift

if [[ $1 = "-p" ]]; then
    params=$params'&'$2
    shift 2
fi

json=$( curl $params -s -X$request -q http://localhost:8080/$*.json) 
returned=$?
if [[ $returned == 0 ]]; then
    print -- "$json" | python -mjson.tool
    exit 0
fi

print -n -- "CURL ERROR $returned: " >&2
case $returned in
    1)    print -- "Unsupported protocol. This build of curl has no support for this protocol." >&2 ;;
    2)    print -- "Failed to initialize." >&2 ;;
    3)    print -- "URL malformed. The syntax was not correct." >&2 ;;
    5)    print -- "Couldn't resolve proxy. The given proxy host could not be resolved." >&2 ;;
    6)    print -- "Couldn't resolve host. The given remote host was not resolved." >&2 ;;
    7)    print -- "Failed to connect to host." >&2 ;;
    8)    print -- "FTP weird server reply. The server sent data curl couldn't parse." >&2 ;;
    9)    print -- "FTP access denied. The server denied login or denied access to the particular resource or directory you wanted  to  reach.">&2
          print -- "Most  often  you tried to change to a directory that doesn't exist on the server." >&2 ;;
   11)    print -- "FTP weird PASS reply. Curl couldn't parse the reply sent to the PASS request." >&2 ;;
   13)    print -- "FTP weird PASV reply, Curl couldn't parse the reply sent to the PASV request." >&2 ;;
   14)    print -- "FTP weird 227 format. Curl couldn't parse the 227-line the server sent." >&2 ;;
   15)    print -- "FTP can't get host. Couldn't resolve the host IP we got in the 227-line." >&2 ;;
   17)    print -- "FTP couldn't set binary. Couldn't change transfer method to binary." >&2 ;;
   18)    print -- "Partial file. Only a part of the file was transferred." >&2 ;;
   19)    print -- "FTP couldn't download/access the given file, the RETR (or similar) command failed." >&2 ;;
   21)    print -- "FTP quote error. A quote command returned error from the server." >&2 ;;
   22)    print -- "HTTP  page not retrieved. The requested url was not found or returned another error with the HTTP error code being 400 or above. This return code only appears if -f/--fail is used." >&2 ;;
   23)    print -- "Write error. Curl couldn't write data to a local filesystem or similar." >&2 ;;
   25)    print -- "FTP couldn't STOR file. The server denied the STOR operation, used for FTP uploading." >&2 ;;
   26)    print -- "Read error. Various reading problems." >&2 ;;
   27)    print -- "Out of memory. A memory allocation request failed." >&2 ;;
   28)    print -- "Operation timeout. The specified time-out period was reached according to the conditions." >&2 ;;
   30)    print -- "FTP PORT failed. The PORT command failed. Not all FTP servers support the PORT command, try doing a transfer using PASV instead!" >&2 ;;
   31)    print -- "FTP couldn't use REST. The REST command failed. This command is used for resumed FTP transfers." >&2 ;;
   33)    print -- "HTTP range error. The range "command" didn't work." >&2 ;;
   35)    print -- "SSL connect error. The SSL handshaking failed." >&2 ;;
   36)    print -- "FTP bad download resume. Couldn't continue an earlier aborted download." >&2 ;;
   37)    print -- "FILE couldn't read file. Failed to open the file. Permissions?" >&2 ;;
   38)    print -- "LDAP cannot bind. LDAP bind operation failed." >&2 ;;
   39)    print -- "LDAP search failed." >&2 ;;
   41)    print -- "Function not found. A required LDAP function was not found." >&2 ;;
   42)    print -- "Aborted by callback. An application told curl to abort the operation." >&2 ;;
   43)    print -- "Internal error. A function was called with a bad parameter." >&2 ;;
   45)    print -- "Interface error. A specified outgoing interface could not be used." >&2 ;;
   47)    print -- "Too many redirects. When following redirects, curl hit the maximum amount." >&2 ;;
   48)    print -- "Unknown TELNET option specified." >&2 ;;
   49)    print -- "Malformed telnet option." >&2 ;;
   52)    print -- "The server didn't reply anything, which here is considered an error." >&2 ;;
   53)    print -- "SSL crypto engine not found." >&2 ;;
   54)    print -- "Cannot set SSL crypto engine as default." >&2 ;;
   55)    print -- "Failed sending network data." >&2 ;;
   56)    print -- "Failure in receiving network data." >&2 ;;
   59)    print -- "Couldn't use specified SSL cipher." >&2 ;;
   60)    print -- "Peer certificate cannot be authenticated with known CA certificates." >&2 ;;
   61)    print -- "Unrecognized transfer encoding." >&2 ;;
   62)    print -- "Invalid LDAP URL." >&2 ;;
   63)    print -- "Maximum file size exceeded." >&2 ;;
   64)    print -- "Requested FTP SSL level failed." >&2 ;;
   65)    print -- "Sending the data requires a rewind that failed." >&2 ;;
   66)    print -- "Failed to initialise SSL Engine." >&2 ;;
   67)    print -- "The user name, password, or similar was not accepted and curl failed to log in." >&2 ;;
   68)    print -- "File not found on TFTP server." >&2 ;;
   70)    print -- "Out of disk space on TFTP server." >&2 ;;
   73)    print -- "File already exists (TFTP)." >&2 ;;
   75)    print -- "Character conversion failed." >&2 ;;
   76)    print -- "Character conversion functions required." >&2 ;;
   77)    print -- "Problem with reading the SSL CA cert (path? access rights?)." >&2 ;;
   78)    print -- "The resource referenced in the URL does not exist." >&2 ;;
   79)    print -- "An unspecified error occurred during the SSH session." >&2 ;;
   80)    print -- "Failed to shut down the SSL connection." >&2 ;;
   82)    print -- "Could not load CRL file, missing or wrong format (added in 7.19.0)." >&2 ;;
   83)    print -- "Issuer check failed (added in 7.19.0)." >&2 ;;
    *)    print -- "Unreferenced CURL error, try man curl" >&2 ;;
esac
